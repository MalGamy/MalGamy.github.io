---
title: Emotet Malware 0x01
classes: wide
header:
  teaser: /img/Emotet.jpg
ribbon: MidnightBlue
categories:
  - Malware-Analysis
toc: true
---
# Introduction
In this part, we will play with code in ```X32dbg``` debugger to unpack Emotet malware and arrive to original entry point (OEP). So you should read the first part to understand this part.

# Sample
MD : CA06ACD3E1CAB1691A7670A5F23BAEF4
# Tools
x32 debugger 
# Jump Instruction 
## Step01
we will load binary of Emotet malware to ```32dbg``` and press ```F9``` to arrive to EntreyPoint and set break point on ```Jump ecx``` instruction and we can see the results in the next figure

![Figure01](https://user-images.githubusercontent.com/74544712/128159253-44179191-bdfb-4904-b8c3-0d50858d5eed.png)

## Step02
From the previous figure, we set break point on Jump ecx instruction. So we can do the next steps.
- Run the debugger by pressing F9 to execute the code till Jump ecx instruction
- And press F7 to execute code one step 
So we can see the steps in the next figure 

![Figure02](https://user-images.githubusercontent.com/74544712/128160816-90f3121c-7579-4287-a60c-b612496f98be.png)

# Abnormal Function 
By doing the previous steps, we can jump to another function. So we will examine it and get some information about instructions. After examining function we can identify some suspicious instruction in the end of function. So we can see the first instructions of function and suspicious end of the function in the next figure.

<p align="center">
<img src="https://user-images.githubusercontent.com/74544712/128161935-0e36585a-983f-4ea0-b232-ded617310ddd.png">
</p>

From the previous figure, we can see the end of the function and the three suspicious instructions. 
```
mov edx,dword ptr ds:[41C1B4] ---> we will set Bp here 
push edx                      
ret

```
## New Allocation 
So, we will do the following steps to see what instructions do.

- Set BP on the instruction ```mov  edx , dword ptr ds:[41C1B4]``` 
- Run debugger by pressing F9

![Figure3-1](https://user-images.githubusercontent.com/74544712/128167266-f7d150b3-1aa6-4ac1-8b64-bb090a0c808e.png)

from the previous figure we can see the value of ```dword ptr ds:[41C1B4]```

- follow the value of ```dword ptr ds:[41C1B4]``` in dump to see what is. we can see that this possible unpacked section.
- press F7 
- and again follow the value of ```dword ptr ds:[41C1B4]``` 

![Figure3-2](https://user-images.githubusercontent.com/74544712/128168096-138c20df-631c-4b00-bff7-028a532c7686.png)

from the previous figure we can see that value of ```dword ptr ds:[41C1B4]``` allocates a new region of memory from previous VirtualAlloc (if you see it in IDA Pro in the frist part).
## Ret Address 
```
push edx     ---> edx = the value of dword ptr ds:[41C1B4]
ret          ---> return address of the new unpacked section 

```
and we can see the resluts in the next figure

![Figure04](https://user-images.githubusercontent.com/74544712/128169708-4d05d847-2a58-47de-b034-8ca34c704121.png)

# unpacked section02 
from the figure, we can see that function return address to another function. So, we will examine the function to extract the important calls and instruction and we can see the results in the next figure 

<p align="center">
<img src="https://user-images.githubusercontent.com/74544712/128170428-e590e28b-886b-4533-a546-a7caccea399f.png">
</p>

From the previous figure, we can see first instructions of function, ```call 22F830``` is called many times and the end of the function. So, we should examine ```call 22F830``` to see what does and why it is called many times.

# Stack Strings 
When examining  call 22F830 we can identify obfuscation technique called stack string to hide the malicious strings or malicious ApIs and handle the operation of reverse engineering and i will work in the frist part of function and we can see the resluts in the next figure

![Figure06](https://user-images.githubusercontent.com/74544712/128177449-9f25b264-7ceb-439e-937d-cd77ef385446.png)
## LoadLibraryEx
From the previous figure, we can execute the code and dump the results and we can see the them in the next figure 

![Figure06](https://user-images.githubusercontent.com/74544712/128178134-9083685c-6aed-40f1-8af3-95ff45fe1932.png)









