---
title: unpackme challenge
classes: wide
header: /img/image_2022-01-29_113830.png
  teaser:
ribbon: MidnightBlue
categories:
  - Malware-Analysis
toc: true
---
# Introducation
in this article, we will see how to solve the ```Ransomed challenge``` and learn the process used by malware analysts to unpack malware that uses a custom packer. 
## Question(1)
In this ``` Question(1)```, I want to learn you how to examine the hash of malware. So we open malware with the PeStudio tool and check the md5 hash and we can see the results in the next figure.
<p align="center">
<img src="https://user-images.githubusercontent.com/74544712/147362245-c8a1cb57-8928-40d2-a80c-9ba1b23eaacf.PNG">
</p>


## Question(2)
In this ``` Question(2)```, I want to learn you how to identify malware is packed or not. so I will open malware with the ```detect it easy``` tool and identify that malware is packed from its entropy value and we can see the results in the next figure.
<p align="center">
<img src="https://user-images.githubusercontent.com/74544712/147362287-88c43498-9847-4a44-ab4b-74f94a906f05.PNG">
</p>

## Question(3)
in this ``` Question(3) ```, I want to learn how to identify the sections and examine them to discover some other indicators that malware is packed, so we will use the PE file tool and I am using the common tool in this point which called Pestudio tool. after opening the malware with this tool and going to the section table we can see that the number of the section is (4) and we can see that in the next figure.
<p align="center">
<img src="https://user-images.githubusercontent.com/74544712/148217363-8e5028a6-09df-4193-85ce-b1673bab316f.PNG">
</p>


## Question(4)
In this ``` Question(4) ```, we want to learn you how to identify that malware is packed in specific section. so i ask the people about .text section and its entropy to see that malware is packed in this section and we can see that in the next figure (4)
<p align="center">
<img src="https://user-images.githubusercontent.com/74544712/148217490-45fc9e7f-05df-45fc-a2a4-f38e7e58c596.PNG">
</p>


## Question(5)
in this ``` Question(5) ```, when malware allocated a region of memory to write the shellcode into it, we can see that the malware uses a common technique, which called "Stack String" to obfuscate the strings and hide them if malware analysts use a utility such "strings" and they don't get any important strings.


## Question(6)
In this ``` Question(6) ```, I want to tell people about the common API that use to allocate a region of memory in the process of unpacking malware, so malware here use the "VirtualAlloc" to allocate a region of memory, and we can see that if we set a breakpoint in the command line of the debugger and run malware with F9.


## Question(7)
in this ``` Question(3) ```, after allocating a region of memory, we can select first bytes into the region of memory and follow them in the memory map and we can see the protection is "ERW" and we can see that in the next figure
<p align="center">
<img src="https://user-images.githubusercontent.com/74544712/148217828-f8d3f0fb-9915-423a-8a34-5f67f02b31da.PNG">
</p>


## Question(8)
After allocating a region of memory and running the malware by F8 and after some lines we can see that malware will write shellcode into this region of memory, and after that malware will store the start address into ``` dword ptr ss: [ebp-4] ``` and use the assembly instruction ``` jmp dword ptr ss: [ebp-4] ``` to transfer the execution and execute the shellcode.
<p align="center">
<img src="https://user-images.githubusercontent.com/74544712/148218225-42547cb0-b3ae-4fee-b64a-cf560bda0142.PNG">
</p>

## Question(9)
In this question, I want to use a different way to see ``` Resolved APIs ``` the first thing dump the shellcode from the allocated region of memory and use ``` scdbg ``` emulator and load the shellcode into it and after that select the option ``` find such ``` and the emulator will ask you about indexes. enter the index of shellcode to see Resolved APIs.
The second way, we need to debug the code in the debugger to see that malware loads the library and after that resolve the APIs from its library.
<p align="center">
<img src="https://user-images.githubusercontent.com/74544712/148224569-c0eb63f1-9205-41ee-bc73-09f290316ac9.PNG">
</p>

## Question(10)
In this question, we want to calculate the APIs that resolved from the kernal32.dll library and easy way uses scdbg. It arranges each library and its APIs that are resolved from it.
<p align="center">
<img src="https://user-images.githubusercontent.com/74544712/148225025-39adcfdf-75b8-4fc1-b2fd-ac65ee39602d.PNG">
</p>

## Question(11)
In this question, I want to ensure that people use a debugger and execute the code line by line and after calling ``` RigisterClassA ```, we can see that malware obfuscate two strings and we can see that in the next figure.
<p align="center">
<img src="https://user-images.githubusercontent.com/74544712/148228418-04c3d4fa-ee88-4bf2-b96d-bb36c30bbd17.PNG">
</p>

## Question(12)
when the malware creates a process, we can see the dwCreationFalg and get its value in ``` hex ```.


## Question(13)
From the dwCreationFalg, we can identify that malware creates a process in suspended mode. And after that use some APIs and write the code with WriteProcessMemory. In the final malware use ResumeThread to execute malicious code and we can see that malware use the Process Hollowing technique to inject code into the suspended process.

## Question(14)
we can see that malware writes the malicious code with WriteProcessMemory API
