---
title: Full analysis droper malware 0x01
classes: wide
header:
  teaser: /img/droper.jpg
ribbon: MidnightBlue
categories:
  - Malware-Analysis
toc: true
---
# Introduction
i am so happy to write about second full analysis for donwnlaoder malware and we will deep into details of analysis 
# Identification  
When scanning the malware with virustotal we can see that the malware has been detected by 10 out of 70 security vendors and we can see the results in the next figure.

![01](https://user-images.githubusercontent.com/74544712/130075381-6ad58634-c61c-4b8d-8dfb-250c73f646fb.PNG)

# Artifacts
We can see the following artifacts that has been analyzed for the sample

- PE timestamp : 2020-06-25 06:30:41
- SHA256 : a4c1473add35a0409fc49c12c344decf8ff71b1029f77de2d20c9794ce387ab9
- Size in KB : 95.50 KB
- File name : sample.bin

# obfuscation
When examining the next figure, we can see that attacker makes array of Base64 data which obfuscate the process of reverse engineering and hidden C&C which will used to download files after getting the temp path directory and also we can see that sample use CryptStringToBinaryA to decode the C&C and after downloading the file, the malware will remove it and we can see the results in the next figures.

![02](https://user-images.githubusercontent.com/74544712/130078744-e774961f-f16e-40a4-bdc5-f38af00f6408.PNG)

Now we get overview about the function and summery for actions that taken by sample. So I will deep into every function to extract more information about the behavior of the sample.
After examining the first function from the parent function, we can see that malware gets the path to temp directory and push the first index of array to decode it and we can decode the first index to get the first C&C and we can see the resluts in the next figure.

![03](https://user-images.githubusercontent.com/74544712/130081933-9ed762e0-9ef6-457a-8cda-09c0cb69fe73.PNG)

After decoding the first index of the array, we can see that malware downloads the file from this link (http://www.elsmap.com/pic1.jpg) and after downloading the file in temp directory the malware will remove file name and C&C which used for downloading the file, So we can see that malware makes for loop to do this operation for 10 times and we can see the result in the next figure

![04](https://user-images.githubusercontent.com/74544712/130083604-a20115cd-5ebe-44a1-8844-58715915baec.PNG)

from the previous figure, we can see for loop and we will see 10 files and 10 C&C to download them in temp directory.

```
http://www.elsmap.com/pic1.jpg       ---> Temp\banner.jpg
http://www.elsmap.com/start.jpg      ---> Temp\start.jpg
http://www.elsmap.com/pic1.jpg       ---> Temp\pic1.jpg 
http://www.elsmap.com/pic1.jpg       ---> Temp\pic2.jpg
http://www.elsmap.com/pic1.jpg       ---> Temp\pic3.jpg
http://www.elsmap.com/pic1.jpg       ---> Temp\pic4.jpg
http://www.elsmap.com/pic1.jpg       ---> Temp\pic5.jpg
http://www.elsmap.com/footer.jpg     ---> Temp\footer.jpg
http://www.elsmap.com/exam/runme.bat ---> Temp\runme.bat
http://www.elsmap.com/header.jpg     ---> Temp\header.jpg

```
# Anti debugging
I will deep into the next function, so we can see in the next figure that malware check being debug in process environment block and if find this flag is one, this mean that the process is running under the debugger and show the message and in the end will exit the process so we can change the path of if condition to bypass this techniques.

![05](https://user-images.githubusercontent.com/74544712/130092018-aa603210-0d55-423a-b767-6855e0da18aa.PNG) 

# Anti Sandbox 
The malware uses anti sandbox tricks to detect running  malware in  sandbox by making if condition on four function and if any function return true the malware will show message sandbox detected and exit process to prevent running malware and we can see that in the next figure.

![06](https://user-images.githubusercontent.com/74544712/130093095-bb46b25b-f6b8-49e8-a0f9-e4ac5623086b.PNG)

So we must examine every function to know about tricks that used by malware to detect the sandbox and I will started by Anti_sanbox_1 to deep into it and I will start by Anti_sanbox_1 function to deep into it, after examining the function we can see that malware gets information about a system using (GetSystemInfo) and then use (GlobalMemoryStatusEx) to retrieve information about the usage of system for physical and virtual memory and we work on virtual machine which uses less physical memory and virtual memory and from here the malware detects the sandbox by using this tricks and the malware also will create file and in the end it will check the DeviceIoControl calls that used to trigger the Virtualbox exploit. So we can see the results in the next figure.

![07](https://user-images.githubusercontent.com/74544712/130096363-3b3c2424-f7cb-46e9-842c-42e99d9e156d.PNG)

I will examine the Anti_sandbox_2 function to know about tricks that used by malware to detect the sandbox , the malware will search in system32 directory for the two file 
- C:\\Windows\\System32\\VBox*.dll
- C:\\Windows\\System32\\vm*.dll
And also open the following two registry key 
- SYSTEM\\ControlSet001\\Services\\VBoxSF
- SYSTEM\\ControlSet001\\Services\\VMTools
After searching about two files and two registers, we can identify that malware tries to find VMware and VirtualBox programs that used as sandbox by this tricks and if the malware find anything from them will detect the sandbox and we can see the results in the next figure.

![08](https://user-images.githubusercontent.com/74544712/130100684-92c30803-b02c-4f60-a058-66613dee6ae8.PNG)


I will examine the Anti_sandbox_3 function to know about tricks that used by malware to detect the sandbox, the malware use K32EnumProcesses to see all process and check for VMware processes or Virtualbox processes.

![09](https://user-images.githubusercontent.com/74544712/130106951-7b135447-a076-4320-aaba-496b04372c00.PNG)

now i check the last function and we can see that the malware use GetTickCount64 to retrieves the number of milliseconds of the execution process to detect the sandbox.

# Updata a system 
If you open the malware in debugger and bypass the anti-debugging and anti-sandbox techniques, the malware will show message and to bypass it, you must click on (No) button to complete the process of debugging the malware and we can see the message in the next figure.

![09](https://user-images.githubusercontent.com/74544712/130108539-0836f0d7-4a76-4cf4-9f7a-09c047dca388.PNG)

Malware download update on a system and check the internet connection with (InternetCheckConnectionA)

![11](https://user-images.githubusercontent.com/74544712/130118468-3c423d27-40a0-44dd-8ace-33757602a87a.PNG)
# persistence
The malware will copy base64 data and pass as first parameter to decode it and after decoding the base64 data the malware will set key to persistence itself and we can the overall in the next figure.

 ![12](https://user-images.githubusercontent.com/74544712/130120549-a732a661-4c60-4307-8328-c08aa86eb7f2.PNG)
 
 when decode the base64 data, we can see the decoded value in the next line. 
 
 ```
 Yzpcd2luZG93c1xzdmNob3N0LmV4ZQ== ---> c:\windows\svchost.exe
 ```
 open the run key and set a key which called ```WizLoader``` and we can see the results in the next figure
 
 ![13](https://user-images.githubusercontent.com/74544712/130121598-e6be3a1a-3f1b-413c-8b84-4d316c5d30a8.PNG)

From the previous figure, we see the path to key and the name of key which called "WizLoader". SO i will go to ```regedit``` from ```run``` to see the key and we can see the result in the next figure.

 ![14](https://user-images.githubusercontent.com/74544712/130122335-bfe9be08-62b9-49c2-813d-587a0035515b.PNG)
 
 so we see that the WizLoader is ```.exe``` and from here we can identify that the malware try to make AutRun for malware.
 the malware copy another base65 data and decode it. so we can see the decode value in the following lines.
 
 ```
 aHR0cDovL3d3dy5lbHNtYXAuY29tL2Jhbm5lci5qcGc= ---> http://www.elsmap.com/banner.jpg
 QzpcV2luZG93c1xTeXN0ZW0zMlxjb25iYXNlLmRsbA== ---> C:\Windows\System32\conbase.dll
 
 ```
we can see the code that copy the previous base64 data and decode them in the next figure.

![15](https://user-images.githubusercontent.com/74544712/130123973-3ed175ef-ee70-4a80-8f60-cf5d0604e6af.PNG)

we will check the next figure to see another information about malware, so we can see that malware try to persistence. We can see that the malware encode the conbase.dll to supply conbase.dll during the system boot for malware and persistence in HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors and we can see that conbase.dll is located in C:\Windows\System32 and we can see the result in the next figure.

![16](https://user-images.githubusercontent.com/74544712/130125882-be918ad8-f212-43f1-addc-b55d44b4e096.PNG)

after that the malware will download file from (http://www.elsmap.com/banner.jpg) and delete the traces behind by deleting the URL that used to download file and we can see the results in the next figure.

![17](https://user-images.githubusercontent.com/74544712/130126275-e426690a-9aa3-48c0-9667-407b1f9e9732.PNG)

let us check the next figure, we can see that malware will generate name for temp file and pass the generated name to (CreateFileA) to create file with generated name and copy Base64 to decode it and write the buffer on the created file and we can see the result in the next figure.

![18](https://user-images.githubusercontent.com/74544712/130126890-21dd9ef5-b877-4bfe-86ca-872195f8b3b9.PNG)

now i will go to the debugger and see the generated name and the created file and we can see the reslut in the next figure.

![19](https://user-images.githubusercontent.com/74544712/130127942-eda1f631-cbad-4b92-80d5-8c35596e9ac2.PNG)

we can see that the malware make for loop to create 5 file and when i examine the first file of them. i can identify that this files is meaningless after writing the buffer in created file and we can see the buffer in the next figure.

![20](https://user-images.githubusercontent.com/74544712/130128906-4a0e89a9-9198-41f9-b9f9-de926b386cdd.PNG)

# Dropper files
After that the malware will create ph.exe file in the same directory and we can see the result in the next figure.

![21](https://user-images.githubusercontent.com/74544712/130129478-5a213568-328f-4e31-bae6-7ad3f34b1cfe.PNG)

i want to see the buffer that will be written on file after creating it and we can see the results in the next figure

![22](https://user-images.githubusercontent.com/74544712/130129948-26a49d54-5cf6-4b18-9b3b-cd62c4a4f6f5.PNG)

the buffer was base64 data and malware decodes it and copy the buffer by ```WriteFileA```. when examining the next function we see the same methodology for crate and decode buffer to create the malicious file which is called Loader.exe and we can see the created file in the next figure.

![23](https://user-images.githubusercontent.com/74544712/130130621-e3d7f5f5-cf40-44c0-99f9-4980a8bb6b16.PNG)

in the last. the malware will execute Load.exe by open cmd.exe as administrator and pass the parameter to execute the malware on system so we can identify the first stage of malware is download another malware and execute on the machine and we can see the resuls in the next figure.

![24](https://user-images.githubusercontent.com/74544712/130131216-520a0742-a727-4ecd-8b29-3264fe1cf611.PNG)

# IOCs

a4c1473add35a0409fc49c12c344decf8ff71b1029f77de2d20c9794ce387ab9
CF48AF5B5779877C3BD9F15A443BE1B1
D2DCC98A3CF29BE377291DAC3EE5DF1C

# C&C
http://www.elsmap.com/header.jpg
http://www.elsmap.com/pic1.jpg       
http://www.elsmap.com/start.jpg      
http://www.elsmap.com/pic1.jpg       
http://www.elsmap.com/footer.jpg
http://www.elsmap.com/exam/runme.bat 





 
























