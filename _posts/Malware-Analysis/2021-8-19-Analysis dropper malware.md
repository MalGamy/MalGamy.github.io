---
title: Emotet Malware 0x02
classes: wide
header:
  teaser: /img/Emotet.jpg
ribbon: MidnightBlue
categories:
  - Malware-Analysis
toc: true
---
# Introduction

# Identification  
When scanning the malware with virustotal we can see that the malware has been detected by 10 out of 70 security vendors and we can see the results in the next figure.

![01](https://user-images.githubusercontent.com/74544712/130075381-6ad58634-c61c-4b8d-8dfb-250c73f646fb.PNG)

We can see the following artifacts that has been analyzed for the sample
- PE timestamp : 2020-06-25 06:30:41
- SHA256 : a4c1473add35a0409fc49c12c344decf8ff71b1029f77de2d20c9794ce387ab9
- Size in KB : 95.50 KB
- File name : sample.bin

When examining the next figure, we can see that attacker makes array of Base64 data which obfuscate the process of reverse  engineering and hidden C&C which will used to download files after getting the temp path directory and also we can see that sample use CryptStringToBinaryA to decode the C&C and after downloading the file, the malware will remove it and we can see the results in the next figures.

![02](https://user-images.githubusercontent.com/74544712/130078744-e774961f-f16e-40a4-bdc5-f38af00f6408.PNG)

Now we get overview about the function and summery for actions that taken by sample. So I will deep into every function to extract more information about the behavior of the sample.
After examining the first function from the parent function, we can see that malware gets the path to temp directory and push the first index of array to decode it and we can decode the first index to get the first C&C and we can see the resluts in the next figure.

![03](https://user-images.githubusercontent.com/74544712/130081933-9ed762e0-9ef6-457a-8cda-09c0cb69fe73.PNG)

After decoding the first index of the array, we can see that malware downloads the file from this link (http://www.elsmap.com/pic1.jpg) and after downloading the file in temp directory the malware will remove file name and C&C which used for downloading the file, So we can see that malware makes for loop to do this operation for 10 times and we can see the result in the next figure

![04](https://user-images.githubusercontent.com/74544712/130083604-a20115cd-5ebe-44a1-8844-58715915baec.PNG)

from the previous figure, we can see for loop and we will see 10 files and 10 C&C to download them in temp directory.

```
http://www.elsmap.com/pic1.jpg       ---> Temp\banner.jpg
http://www.elsmap.com/start.jpg      ---> Temp\start.jpg
http://www.elsmap.com/pic1.jpg       ---> Temp\pic1.jpg 
http://www.elsmap.com/pic1.jpg       ---> Temp\pic2.jpg
http://www.elsmap.com/pic1.jpg       ---> Temp\pic3.jpg
http://www.elsmap.com/pic1.jpg       ---> Temp\pic4.jpg
http://www.elsmap.com/pic1.jpg       ---> Temp\pic5.jpg
http://www.elsmap.com/footer.jpg     ---> Temp\footer.jpg
http://www.elsmap.com/exam/runme.bat ---> Temp\runme.bat
http://www.elsmap.com/header.jpg     ---> Temp\header.jpg

```
I will deep into the next function, so we can see in the next figure that malware check being debug in process environment block and if find this flag is one, this mean that the process is running under the debugger and show the message and in the end will exit the process so we can change the path of if condition to bypass this techniques.

![05](https://user-images.githubusercontent.com/74544712/130092018-aa603210-0d55-423a-b767-6855e0da18aa.PNG)

The malware uses anti sandbox tricks to detect running  malware in  sandbox by making if condition on four function and if any function return true the malware will show message sandbox detected and exit process to prevent running malware and we can see that in the next figure.

![06](https://user-images.githubusercontent.com/74544712/130093095-bb46b25b-f6b8-49e8-a0f9-e4ac5623086b.PNG)

So we must examine every function to know about tricks that used by malware to detect the sandbox and I will started by Anti_sanbox_1 to deep into it and I will start by Anti_sanbox_1 function to deep into it, after examining the function we can see that malware gets information about a system using (GetSystemInfo) and then use (GlobalMemoryStatusEx) to retrieve information about the usage of system for physical and virtual memory and we work on virtual machine which uses less physical memory and virtual memory and from here the malware detects the sandbox by using this tricks and the malware also will create file and in the end it will check the DeviceIoControl calls that used to trigger the Virtualbox exploit. So we can see the results in the next figure.

![07](https://user-images.githubusercontent.com/74544712/130096363-3b3c2424-f7cb-46e9-842c-42e99d9e156d.PNG)



















